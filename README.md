# Todo Sync & Mobile Access

Этот репозиторий теперь содержит два варианта интерфейса списка дел:
- расширение Chrome (side panel);
- веб-приложение, которое можно открыть на телефоне и установить как PWA.

Добавлена синхронизация через простой REST-сервер, поэтому задачи остаются общими между расширением и мобильной версией.

## Требования
- Node.js 18+
- npm 9+

## Установка зависимостей
```bash
npm install
```

## Настройка синхронизации
1. Отредактируйте файл `scripts/sync-config.js` и пропишите адрес вашего сервера:
   ```js
   export const syncConfig = {
     enabled: true,
     baseUrl: 'https://example.com', // адрес деплоя сервера из директории server/
     pullOnStartup: true,
     pushDebounceMs: 1500,
     pullIntervalMs: 2500
   };
   ```
2. Запустите сервер синхронизации локально:
   ```bash
   npm run dev:server
   ```
   По умолчанию сервер слушает порт `8787`, хранит состояние в файле `server/storage.json` и раздаёт веб-интерфейс по адресу `http://localhost:8787/web/` (корень `/` перенаправляет туда же).
   Страница входа доступна на `http://localhost:8787/auth/`.
3. (Опционально) Укажите переменные окружения, если размещаете сервер в облаке:
   - `PORT` — внешний порт;
   - `TODO_SYNC_DB` — путь к JSON-файлу с состоянием;
   - `TODO_SESSION_TTL` — время жизни access-токена в миллисекундах (по умолчанию ~30 дней).
4. Соберите фронтенд или откройте расширение и авторизуйтесь: теперь учетные данные вводятся прямо в приложении, а сервер выдаёт Bearer-токен, который сохраняется в локальном хранилище/`chrome.storage`.

Когда синхронизация включена, любое изменение списка автоматически отправляется на сервер, а при старте приложение подтягивает последнюю версию. Веб-версия и расширение используют единый API и единое состояние.

## Запуск расширения Chrome
1. Соберите или настройте синхронизацию (см. выше).
2. В Chrome откройте `chrome://extensions` и включите режим разработчика.
3. Нажмите «Загрузить распакованное расширение» и выберите директорию репозитория.
4. Откройте боковую панель Chrome и проверьте, что задачи синхронизируются.

## Веб-версия / мобильный доступ
1. Локально достаточно `npm run dev:server` — интерфейс будет доступен на `http://localhost:8787/web/`. Первое, что увидите, — встроенное окно входа.
2. Для продакшн-развёртывания можно использовать Render/Netlify и др.: API и статика обслуживаются одним приложением, поэтому после деплоя откройте `https://<ваш-домен>/web/`. При необходимости отдельная страница `https://<домен>/auth/` предлагает тот же сценарий входа/регистрации.

### Авторизация
- Окно входа встроено в сам список дел (как в расширении, так и в PWA). Введите email и пароль — сервер создаст учётную запись при регистрации и вернёт Bearer-токен.
- Токен хранится локально (`chrome.storage` в расширении и `localStorage` в веб-версии) и автоматически подставляется в запросы `Authorization: Bearer …`.
- Кнопка «Выйти» очищает токен и локальные данные — при следующем запуске снова появится окно входа.
- Отдельная страница `https://<домен>/auth/` использует те же API и может пригодиться, если нужно авторизоваться через браузер перед установкой PWA.
3. На телефоне нажмите «Добавить на главный экран». Благодаря `manifest.webmanifest` и сервис-воркеру `web/sw.js` веб-приложение устанавливается как PWA и работает в полноэкранном режиме.

### Замечания
- Для корректной работы синхронизации и мобильной версии сервер должен быть доступен из сети телефона.
- Если вы меняете `sync-config.js`, обновите PWA (меню браузера → «Обновить приложение»), потому что файл кэшируется сервис-воркером.
- Файл `server/storage.json` можно резервировать или заменить на любую БД по вашему желанию — главное, чтобы API сохранял и отдавал объект состояния целиком.
- Поле `pullIntervalMs` в конфиге отвечает за периодичность фонового опроса сервера; значение 500–1000 мс даёт почти мгновенную синхронизацию.
- Для iOS рекомендации Apple соблюдены — в `web/index.html` подключён `apple-touch-icon-180.png` (180×180).

## Структура
- `scripts/` — общий код интерфейса и синхронизации.
- `web/` — веб/PWA-оболочка.
- `server/` — express-сервер для хранения состояния.
- `icons/` — набор иконок для расширения и PWA.

Если нужно расширить API (например, добавить несколько пользователей или историю изменений), начните с `server/index.js` и `scripts/sync.js`.
