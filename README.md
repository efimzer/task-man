# Todo Sync & Mobile Access

Этот репозиторий теперь содержит два варианта интерфейса списка дел:
- расширение Chrome (side panel);
- веб-приложение, которое можно открыть на телефоне и установить как PWA.

Добавлена синхронизация через простой REST-сервер, поэтому задачи остаются общими между расширением и мобильной версией.

## Требования
- Node.js 18+
- npm 9+

## Установка зависимостей
```bash
npm install
```

## Настройка синхронизации
1. Отредактируйте файл `scripts/sync-config.js` и задайте свои параметры:
   ```js
    export const syncConfig = {
      enabled: true,
      baseUrl: 'https://example.com', // адрес вашего sync-сервера
      userId: 'my-user',              // любой уникальный идентификатор
      authToken: 'секрет-токен',      // необязательно, но рекомендуется
      authTokenInQuery: false,        // добавить ?token=... к запросам
      useSessionAuth: false,          // включить cookie-сессии при совместном домене
      pullOnStartup: true,
      pushDebounceMs: 1500,
      pullIntervalMs: 2500          // как часто подтягивать обновления (мс)
    };
   ```
2. Запустите сервер синхронизации локально:
   ```bash
   npm run dev:server
   ```
   По умолчанию сервер слушает порт `8787`, хранит состояние в файле `server/storage.json` и раздаёт веб-интерфейс по адресу `http://localhost:8787/web/` (корень `/` перенаправляет туда же).
   Страница входа доступна на `http://localhost:8787/auth/`.
3. (Опционально) Укажите переменные окружения, если размещаете сервер в облаке:
   - `PORT` — внешний порт;
   - `TODO_SYNC_DB` — путь к JSON-файлу с состоянием;
   - `TODO_SYNC_TOKEN` — токен, который сервер будет ожидать в заголовке `Authorization: Bearer ...`.
   - `TODO_SESSION_COOKIE` — имя cookie для сессии (по умолчанию `todo_session`);
   - `TODO_SESSION_TTL` — время жизни сессии в миллисекундах (по умолчанию ~28 дней);
   - `COOKIE_SECURE` — установите `true`, чтобы cookie передавались только по HTTPS.
4. Если вы используете токен, пропишите его же в `syncConfig.authToken`.

Когда синхронизация включена, любое изменение списка автоматически отправляется на сервер, а при старте приложение подтягивает последнюю версию. Веб-версия и расширение используют единый API и единое состояние.

## Запуск расширения Chrome
1. Соберите или настройте синхронизацию (см. выше).
2. В Chrome откройте `chrome://extensions` и включите режим разработчика.
3. Нажмите «Загрузить распакованное расширение» и выберите директорию репозитория.
4. Откройте боковую панель Chrome и проверьте, что задачи синхронизируются.

## Веб-версия / мобильный доступ
1. Локально достаточно `npm run dev:server` — интерфейс будет доступен на `http://localhost:8787/web/` (после входа по адресу `/auth/`).
2. Для продакшн-развёртывания можно использовать Render/Netlify и др.: API и статика теперь обслуживаются одним приложением, поэтому после деплоя откройте `https://<ваш-домен>/auth/` для входа и `https://<ваш-домен>/web/` для работы со списком.

### Авторизация
- Страница `https://<домен>/auth/` содержит формы входа и регистрации (стилизована в духе Click Tracker).
- Регистрация требует только email и пароль (6+ символов), после создания аккаунта сразу выдаётся cookies-сессия и включается редирект на `/web/`.
- Повторный вход создаёт новую сессию; кнопка «Выйти» удаляет куки и session-запись на сервере.
- API `/state/...` принимает как cookie-сессии, так и прежний Bearer-токен/`?token=` — можно выбрать удобный способ.
3. На телефоне нажмите «Добавить на главный экран». Благодаря `manifest.webmanifest` и сервис-воркеру `web/sw.js` веб-приложение устанавливается как PWA и работает в полноэкранном режиме.

### Замечания
- Для корректной работы синхронизации и мобильной версии сервер должен быть доступен из сети телефона.
- Если вы меняете `sync-config.js`, обновите PWA (меню браузера → «Обновить приложение»), потому что файл кэшируется сервис-воркером.
- Файл `server/storage.json` можно резервировать или заменить на любую БД по вашему желанию — главное, чтобы API сохранял и отдавал объект состояния целиком.
- Поле `pullIntervalMs` в конфиге отвечает за периодичность фонового опроса сервера; значение 500–1000 мс даёт почти мгновенную синхронизацию.
- Для iOS рекомендации Apple соблюдены — в `web/index.html` подключён `check-ios.png` как `apple-touch-icon` (180×180).
- Если нужно открывать API в браузере без ручной установки заголовков, включите `authTokenInQuery` (и/или добавьте `?token=...` к адресу) — сервер теперь принимает токен как в заголовке `Authorization`, так и в параметре запроса.

## Структура
- `scripts/` — общий код интерфейса и синхронизации.
- `web/` — веб/PWA-оболочка.
- `server/` — express-сервер для хранения состояния.
- `icons/` — набор иконок для расширения и PWA.

Если нужно расширить API (например, добавить несколько пользователей или историю изменений), начните с `server/index.js` и `scripts/sync.js`.
